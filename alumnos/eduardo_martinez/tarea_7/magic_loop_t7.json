{"paragraphs":[{"text":"%pyspark\n\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql.functions import col\nfrom pyspark.ml.feature import StringIndexer, IndexToString, VectorAssembler, VectorIndexer\nfrom pyspark.ml.regression import GBTRegressor, RandomForestRegressor, DecisionTreeRegressor, GeneralizedLinearRegression\nfrom pyspark.ml.evaluation import RegressionEvaluator\nfrom pyspark.ml.tuning import CrossValidator, ParamGridBuilder\nfrom pyspark.ml import Pipeline, Model\nfrom timeit import default_timer as timer","user":"anonymous","dateUpdated":"2018-05-03T01:13:50+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1525306335891_-935450912","id":"20180503-001215_159992109","dateCreated":"2018-05-03T00:12:15+0000","dateStarted":"2018-05-03T01:13:50+0000","dateFinished":"2018-05-03T01:13:50+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:268"},{"text":"%pyspark\n\nspark = SparkSession.builder.getOrCreate()\n\nflights = spark.read\\\n    .format('org.apache.spark.sql.execution.datasources.csv.CSVFileFormat')\\\n    .option('header', 'true')\\\n    .option('inferSchema', 'true')\\\n    .load('s3a://eduardomtz/flights/input_data/flights/flights.csv')\n\ndf_flights = flights.filter(\"CANCELLED = 0\") \\\n    .select(\"DEPARTURE_DELAY\",\n            \"MONTH\", \n            \"DAY\",\n            \"DAY_OF_WEEK\", \n            \"AIRLINE\",\n            \"ORIGIN_AIRPORT\", \n            \"DESTINATION_AIRPORT\", \n            \"TAXI_OUT\", \n            \"SCHEDULED_TIME\",\n            \"ELAPSED_TIME\", \n            \"AIR_TIME\", \n            \"DISTANCE\", \n            \"TAXI_IN\", \n            \"ARRIVAL_DELAY\",\n            \"DIVERTED\")\n            \ndf_flights = df_flights.na.drop(subset=[\"DEPARTURE_DELAY\",\n                                  \"MONTH\",\n                                  \"DAY\",\n                                  \"DAY_OF_WEEK\",\n                                  \"AIRLINE\",\n                                  \"ORIGIN_AIRPORT\", \n                                  \"DESTINATION_AIRPORT\", \n                                  \"TAXI_OUT\", \n                                  \"SCHEDULED_TIME\",\n                                  \"ELAPSED_TIME\", \n                                  \"AIR_TIME\", \n                                  \"DISTANCE\", \n                                  \"TAXI_IN\", \n                                  \"ARRIVAL_DELAY\",\n                                  \"DIVERTED\"])\n                                  \ndf_flights = df_flights.select(col(\"DEPARTURE_DELAY\").cast(\"integer\").alias(\"label\"),\n                               col(\"MONTH\").cast(\"integer\"), \n                               col(\"DAY\").cast(\"integer\"),\n                               col(\"DAY_OF_WEEK\").cast(\"integer\"), \n                               \"AIRLINE\",\n                               \"ORIGIN_AIRPORT\", \n                               \"DESTINATION_AIRPORT\", \n                               col(\"TAXI_OUT\").cast(\"integer\"), \n                               col(\"SCHEDULED_TIME\").cast(\"integer\"), \n                               col(\"ELAPSED_TIME\").cast(\"integer\"), \n                               col(\"AIR_TIME\").cast(\"integer\"), \n                               col(\"DISTANCE\").cast(\"integer\"), \n                               col(\"TAXI_IN\").cast(\"integer\"), \n                               col(\"ARRIVAL_DELAY\").cast(\"integer\"),\n                               col(\"DIVERTED\").cast(\"integer\"))\n","user":"anonymous","dateUpdated":"2018-05-03T01:13:50+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1525306355492_1773596742","id":"20180503-001235_1935019072","dateCreated":"2018-05-03T00:12:35+0000","dateStarted":"2018-05-03T01:13:50+0000","dateFinished":"2018-05-03T01:14:02+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:269"},{"text":"%pyspark\n\ndf_flights.show()","user":"anonymous","dateUpdated":"2018-05-03T01:13:50+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-----+-----+---+-----------+-------+--------------+-------------------+--------+--------------+------------+--------+--------+-------+-------------+--------+\n|label|MONTH|DAY|DAY_OF_WEEK|AIRLINE|ORIGIN_AIRPORT|DESTINATION_AIRPORT|TAXI_OUT|SCHEDULED_TIME|ELAPSED_TIME|AIR_TIME|DISTANCE|TAXI_IN|ARRIVAL_DELAY|DIVERTED|\n+-----+-----+---+-----------+-------+--------------+-------------------+--------+--------------+------------+--------+--------+-------+-------------+--------+\n|  -11|    1|  1|          4|     AS|           ANC|                SEA|      21|           205|         194|     169|    1448|      4|          -22|       0|\n|   -8|    1|  1|          4|     AA|           LAX|                PBI|      12|           280|         279|     263|    2330|      4|           -9|       0|\n|   -2|    1|  1|          4|     US|           SFO|                CLT|      16|           286|         293|     266|    2296|     11|            5|       0|\n|   -5|    1|  1|          4|     AA|           LAX|                MIA|      15|           285|         281|     258|    2342|      8|           -9|       0|\n|   -1|    1|  1|          4|     AS|           SEA|                ANC|      11|           235|         215|     199|    1448|      5|          -21|       0|\n|   -5|    1|  1|          4|     DL|           SFO|                MSP|      18|           217|         230|     206|    1589|      6|            8|       0|\n|   -6|    1|  1|          4|     NK|           LAS|                MSP|      11|           181|         170|     154|    1299|      5|          -17|       0|\n|   14|    1|  1|          4|     US|           LAX|                CLT|      13|           273|         249|     228|    2125|      8|          -10|       0|\n|  -11|    1|  1|          4|     AA|           SFO|                DFW|      17|           195|         193|     173|    1464|      3|          -13|       0|\n|    3|    1|  1|          4|     DL|           LAS|                ATL|      12|           221|         203|     186|    1747|      5|          -15|       0|\n|   -6|    1|  1|          4|     DL|           DEN|                ATL|      12|           173|         149|     133|    1199|      4|          -30|       0|\n|   -8|    1|  1|          4|     AA|           LAS|                MIA|      21|           268|         266|     238|    2174|      7|          -10|       0|\n|    0|    1|  1|          4|     DL|           LAX|                MSP|      18|           214|         210|     188|    1535|      4|           -4|       0|\n|   -6|    1|  1|          4|     DL|           SLC|                ATL|      18|           215|         199|     176|    1590|      5|          -22|       0|\n|   -1|    1|  1|          4|     DL|           SEA|                MSP|      28|           189|         198|     166|    1399|      4|            8|       0|\n|   -4|    1|  1|          4|     AS|           ANC|                SEA|      17|           204|         194|     173|    1448|      4|          -14|       0|\n|  -14|    1|  1|          4|     DL|           ANC|                SEA|      25|           210|         200|     171|    1448|      4|          -24|       0|\n|   -6|    1|  1|          4|     UA|           SFO|                IAH|      11|           218|         217|     199|    1635|      7|           -7|       0|\n|   -4|    1|  1|          4|     AS|           ANC|                PDX|      11|           215|         201|     187|    1542|      3|          -18|       0|\n|   -5|    1|  1|          4|     DL|           PDX|                MSP|       9|           193|         186|     171|    1426|      6|          -12|       0|\n+-----+-----+---+-----------+-------+--------------+-------------------+--------+--------------+------------+--------+--------+-------+-------------+--------+\nonly showing top 20 rows\n\n"}]},"apps":[],"jobName":"paragraph_1525306394281_1389445485","id":"20180503-001314_226039331","dateCreated":"2018-05-03T00:13:14+0000","dateStarted":"2018-05-03T01:13:50+0000","dateFinished":"2018-05-03T01:14:04+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:270"},{"text":"%pyspark\n\ntrain_flights, test_flights = df_flights.randomSplit([0.7, 0.3])","user":"anonymous","dateUpdated":"2018-05-03T01:13:50+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1525306479411_854952642","id":"20180503-001439_1293615922","dateCreated":"2018-05-03T00:14:39+0000","dateStarted":"2018-05-03T01:14:03+0000","dateFinished":"2018-05-03T01:14:04+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:271"},{"text":"%pyspark\n\nprint(\"Número de registros de entrenamiento: \" + str(train_flights.count()))\nprint(\"Número de registros de prueba: \" + str(test_flights.count()))","user":"anonymous","dateUpdated":"2018-05-03T01:13:50+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Número de registros de entrenamiento: 4001038\nNúmero de registros de prueba: 1712970\n"}]},"apps":[],"jobName":"paragraph_1525306604053_-698477882","id":"20180503-001644_625755482","dateCreated":"2018-05-03T00:16:44+0000","dateStarted":"2018-05-03T01:14:04+0000","dateFinished":"2018-05-03T01:14:29+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:272"},{"text":"%pyspark\n\naerolin_indexada = StringIndexer(inputCol=\"AIRLINE\", outputCol=\"AIRLINE_NUM\").setHandleInvalid(\"skip\")\norigen_indexada = StringIndexer(inputCol=\"ORIGIN_AIRPORT\", outputCol=\"ORIGIN_AIRPORT_NUM\").setHandleInvalid(\"skip\")\ndestino_indexada = StringIndexer(inputCol=\"DESTINATION_AIRPORT\", outputCol=\"DESTINATION_AIRPORT_NUM\").setHandleInvalid(\"skip\")\nvectorAssembler_features = VectorAssembler(inputCols=[\"MONTH\",\n                                                      \"DAY\",\n                                                      \"DAY_OF_WEEK\",\n                                                      \"AIRLINE_NUM\",\n                                                      \"ORIGIN_AIRPORT_NUM\",\n                                                      \"DESTINATION_AIRPORT_NUM\",\n                                                      \"TAXI_OUT\",\n                                                      \"SCHEDULED_TIME\",\n                                                      \"ELAPSED_TIME\",\n                                                      \"AIR_TIME\",\n                                                      \"DISTANCE\",\n                                                      \"TAXI_IN\", \n                                                      \"ARRIVAL_DELAY\",\n                                                      \"DIVERTED\"],\n                                            outputCol=\"features\")","user":"anonymous","dateUpdated":"2018-05-03T01:13:50+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1525306629644_1362434796","id":"20180503-001709_226340526","dateCreated":"2018-05-03T00:17:09+0000","dateStarted":"2018-05-03T01:14:04+0000","dateFinished":"2018-05-03T01:14:29+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:273"},{"text":"%pyspark\n\nmetod = {\n    'gbt': GBTRegressor(labelCol=\"label\", featuresCol=\"features\", maxBins = 640),\n\t'mlg': GeneralizedLinearRegression(labelCol=\"label\", featuresCol=\"features\", family=\"gaussian\", link=\"identity\")\n}\n\ngrid = {\n    'gbt': ParamGridBuilder() \\\n        .addGrid(metod['gbt'].maxDepth, [2, 5, 7])\\\n        .addGrid(metod['gbt'].maxIter, [3, 5, 9])\\\n        .build(),\n    \n    'mlg': ParamGridBuilder() \\\n        .addGrid(metod['mlg'].regParam, [0.1, 0.3, 0.5])\\\n        .addGrid(metod['mlg'].maxIter, [3, 5, 9])\\\n        .build()\n}\n\n\ndef magic_loop(metod_ejec, metod, grid, train):\n    ## Parametros:\n    ## metod_ejec: Lista de modelos a ejecutar\n    ## metod: Diccionario de modelos que se consideraran\n    ## grid: ParamGrid con los parametros de los modelos a considerar\n    ## train: datos de entrenamiento\n    \n    ## Se inicializan variables\n    mejor_score = 0\n    mejor_modelo = ''\n    \n    print(\"Modelo\\tMetrica_desemp\")\n    \n    for index, mdl in enumerate([metod[x] for x in metod_ejec]):\n\n        pipeline_gral = Pipeline(stages=[aerolin_indexada,                                      \n                                       origen_indexada,\n                                       destino_indexada,\n                                       vectorAssembler_features,\n                                       mdl])\n\n        crossval = CrossValidator(estimator=pipeline_gral,\n                                  estimatorParamMaps=grid[metod_ejec[index]],\n                                  evaluator=RegressionEvaluator(),\n                                  numFolds=10)       \n\n        cvModel = crossval.fit(train)\n\n        print(\"{}\\t{}\".format(metod_ejec[index], cvModel.avgMetrics[0]))\n    \n        ## Se condiciona a seleccionar entre los modelos el mejor entre los modelos probados:\n        if (mejor_score == 0) or (cvModel.avgMetrics[0] < mejor_score):\n            mejor_score = cvModel.avgMetrics[0]\n            mejor_modelo = cvModel\n            \n    return mejor_modelo","user":"anonymous","dateUpdated":"2018-05-03T07:14:53+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1525306761680_-243290930","id":"20180503-001921_126622560","dateCreated":"2018-05-03T00:19:21+0000","dateStarted":"2018-05-03T02:34:23+0000","dateFinished":"2018-05-03T02:34:23+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:274"},{"text":"%pyspark\n\n## Modelos que se ejecutaran\nmetod_ejec=['mlg','gbt']\n\n## Ejecucion de la funcion funcion Magic Loop\nstart = timer()\nejec_magicloop = magic_loop(metod_ejec, metod, grid, train_flights)\nend = timer()","user":"anonymous","dateUpdated":"2018-05-03T03:53:37+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1525306975168_896228567","id":"20180503-002255_1419219086","dateCreated":"2018-05-03T00:22:55+0000","dateStarted":"2018-05-03T03:53:37+0000","dateFinished":"2018-05-03T05:55:20+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:275","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Modelo\tMetrica_desemp\nmlg\t1.93995946011\ngbt\t15.7191088344\n"}]}},{"text":"%pyspark\n\nprint(\"Tiempo de ejecucion en minutos:\", (end - start)/60)","user":"anonymous","dateUpdated":"2018-05-03T07:00:40+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1525307131639_-1579014349","id":"20180503-002531_2097322974","dateCreated":"2018-05-03T00:25:31+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:276","dateFinished":"2018-05-03T07:00:40+0000","dateStarted":"2018-05-03T07:00:40+0000","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"('Tiempo de ejecucion en minutos:', 121.72386910120646)\n"}]}},{"text":"%pyspark\n\nejec_magicloop.avgMetrics[0]","user":"anonymous","dateUpdated":"2018-05-03T07:00:51+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1525327054748_-197252917","id":"20180503-055734_194930178","dateCreated":"2018-05-03T05:57:34+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:838","dateFinished":"2018-05-03T07:00:51+0000","dateStarted":"2018-05-03T07:00:51+0000","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"1.9399594601144243\n"}]}},{"text":"%pyspark\n\npredict = ejec_magicloop.transform(test_flights)\npredict.select('features', 'prediction').show()","user":"anonymous","dateUpdated":"2018-05-03T07:00:55+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1525327140400_1988980634","id":"20180503-055900_877775818","dateCreated":"2018-05-03T05:59:00+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:913","dateFinished":"2018-05-03T07:00:57+0000","dateStarted":"2018-05-03T07:00:55+0000","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+-------------------+\n|            features|         prediction|\n+--------------------+-------------------+\n|[1.0,11.0,7.0,9.0...|  -36.8819235014684|\n|[1.0,6.0,2.0,3.0,...| -35.94342573429189|\n|[1.0,10.0,6.0,9.0...|-29.045780694154047|\n|[1.0,2.0,5.0,9.0,...|-25.815939876304025|\n|[1.0,6.0,2.0,3.0,...|-25.858075389266496|\n|[1.0,11.0,7.0,9.0...| -24.47038263713324|\n|[1.0,7.0,3.0,3.0,...| -25.19230341502533|\n|[1.0,3.0,6.0,9.0,...| -24.26033675322163|\n|[1.0,6.0,2.0,2.0,...| -19.05042279464255|\n|[1.0,8.0,4.0,9.0,...| -23.08182459194173|\n|[1.0,4.0,7.0,3.0,...|-19.144489053497296|\n|[1.0,7.0,3.0,3.0,...|-24.834842281271612|\n|[1.0,9.0,5.0,9.0,...| -21.32883512861781|\n|[1.0,10.0,6.0,9.0...|-19.675505838914763|\n|[1.0,11.0,7.0,2.0...|-22.064359178051514|\n|[1.0,5.0,1.0,3.0,...|-18.896759277874274|\n|[1.0,7.0,3.0,9.0,...| -18.13575808108151|\n|[1.0,9.0,5.0,9.0,...|-17.465003539116193|\n|[1.0,10.0,6.0,9.0...|-20.526567315626444|\n|[1.0,3.0,6.0,10.0...|-18.891825299310064|\n+--------------------+-------------------+\nonly showing top 20 rows\n\n"}]}},{"text":"%pyspark\n\nevaluator = RegressionEvaluator(labelCol=\"label\", predictionCol=\"prediction\", metricName=\"rmse\")\n\nrmse = evaluator.evaluate(predict)\nprint(\"Error cuadrático medio sobre los datos de prueba = %g\" % rmse)","user":"anonymous","dateUpdated":"2018-05-03T07:01:00+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1525327219559_-902099222","id":"20180503-060019_141068842","dateCreated":"2018-05-03T06:00:19+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1075","dateFinished":"2018-05-03T07:01:12+0000","dateStarted":"2018-05-03T07:01:00+0000","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"Error cuadrático medio sobre los datos de prueba = 1.93941\n"}]}},{"text":"\n","user":"anonymous","dateUpdated":"2018-05-03T07:55:02+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"text","editOnDblClick":false},"editorMode":"ace/mode/text"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1525327398180_-1374526543","id":"20180503-060318_740850775","dateCreated":"2018-05-03T06:03:18+0000","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1162"}],"name":"magic_loop_t7","id":"2DC2DUV6V","angularObjects":{"2BRWU4WXC:shared_process":[],"2AM1YV5CU:shared_process":[],"2AJXGMUUJ:shared_process":[],"2ANGGHHMQ:shared_process":[],"2AKK3QQXU:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}