{"paragraphs":[{"title":"Tarea 6","text":"%md\n\n### Rafael Larrazolo 118426\n### Métodos de gran escala\n","dateUpdated":"2018-03-18T23:33:06+0000","config":{"tableHide":false,"editorSetting":{"language":"markdown","editOnDblClick":true},"colWidth":12,"editorMode":"ace/mode/markdown","editorHide":true,"title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"HTML","data":"<h3>Rafael Larrazolo 118426</h3>\n<h3>Métodos de gran escala</h3>\n"}]},"apps":[],"jobName":"paragraph_1521398723757_698785292","id":"20180317-032715_1160982334","dateCreated":"2018-03-18T18:45:23+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:3643","user":"anonymous","dateFinished":"2018-03-18T23:33:06+0000","dateStarted":"2018-03-18T23:33:06+0000"},{"title":"Lectura de Datos","text":"%pyspark\nemployees=spark.read.csv(\"s3a://larrazolo/data/northwind/employees.csv\", header = True, inferSchema =True)\norders=spark.read.csv(\"s3a://larrazolo/data/northwind/orders.csv\", header = True, inferSchema =True)\n\nairlines=spark.read.csv(\"s3a://larrazolo/data/flights/airlines.csv\", header = True, inferSchema =True)\nairports=spark.read.csv(\"s3a://larrazolo/data/flights/airports.csv\", header = True, inferSchema =True)\nflights=spark.read.csv(\"s3a://larrazolo/data/flights/flights.csv\", header = True, inferSchema =True)\n","dateUpdated":"2018-03-18T23:51:39+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1521398723761_709558261","id":"20180316-193529_126081548","dateCreated":"2018-03-18T18:45:23+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3644","user":"anonymous","dateFinished":"2018-03-18T23:38:29+0000","dateStarted":"2018-03-18T23:37:59+0000"},{"title":"Pregunta 1A","text":"%pyspark\n# Cuántos jefes hay.\n# Información de los jefes\n\njefes = employees\\\n    .select(\"reportsto\")\\\n    .distinct().\\\n    filter(employees.reportsto > 0)\n\njefesid = jefes\\\n    .select(\"reportsto\")\\\n    .rdd.flatMap(lambda x: x)\\\n    .collect()\n    \np1a = employees[employees.employeeid.isin(jefesid)]\\\n    .select(\"employeeid\",\"firstname\", \"lastname\", \"title\", \"birthdate\", \"hiredate\", \"city\", \"country\" )\n    \np1a.write.csv('s3a://larrazolo/output/tarea6/p1a.csv')\n\np1a.show()\n\n\n\n","dateUpdated":"2018-03-19T00:24:58+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+----------+---------+--------+--------------------+-------------------+-------------------+------+-------+\n|employeeid|firstname|lastname|               title|          birthdate|           hiredate|  city|country|\n+----------+---------+--------+--------------------+-------------------+-------------------+------+-------+\n|         2|   Andrew|  Fuller|Vice President, S...|1952-02-19 00:00:00|1992-08-14 00:00:00|Tacoma|    USA|\n|         5|   Steven|Buchanan|       Sales Manager|1955-03-04 00:00:00|1993-10-17 00:00:00|London|     UK|\n+----------+---------+--------+--------------------+-------------------+-------------------+------+-------+\n\n"}]},"apps":[],"jobName":"paragraph_1521398723762_710712508","id":"20180316-204205_1513967801","dateCreated":"2018-03-18T18:45:23+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3645","user":"anonymous","dateFinished":"2018-03-19T00:25:06+0000","dateStarted":"2018-03-19T00:24:58+0000"},{"title":"Pregunta 1B","text":"%pyspark\n# ¿Quién es el segundo \"mejor\" empleado que más órdenes ha generado? (nombre, apellido, título, cuándo entró a la compañía, número de órdenes generadas, número de órdenes generadas por el mejor empleado (número 1)) \n\nfrom pyspark.sql.functions import lag, col, lead\nfrom pyspark.sql.window import Window\n\n\np1b =orders\\\n    .groupBy(\"employeeid\")\\\n    .count()\\\n    .orderBy(\"count\", ascending=True)\n\nw = Window()\\\n    .partitionBy()\\\n    .orderBy(col(\"count\"))\n\np1b = p1b\\\n    .select(\"*\", lead(\"count\")\\\n    .over(w)\\\n    .alias(\"orders_from_best\"))\\\n    .na.drop()\\\n    .orderBy(\"count\", ascending=False)\\\n    .limit(1)\n\np1b = p1b\\\n    .join(employees, [\"employeeid\"])\\\n    .select(\"employeeid\",\"firstname\", \"lastname\", \"title\", \"hiredate\", \"count\", \"orders_from_best\")\n\np1b.write.csv('s3a://larrazolo/output/tarea6/p1b.csv')\n\np1b.show()\n","dateUpdated":"2018-03-19T00:26:22+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+----------+---------+---------+--------------------+-------------------+-----+----------------+\n|employeeid|firstname| lastname|               title|           hiredate|count|orders_from_best|\n+----------+---------+---------+--------------------+-------------------+-----+----------------+\n|         3|    Janet|Leverling|Sales Representative|1992-04-01 00:00:00|  127|             156|\n+----------+---------+---------+--------------------+-------------------+-----+----------------+\n\n"}]},"apps":[],"jobName":"paragraph_1521398723762_710712508","id":"20180316-193928_478839448","dateCreated":"2018-03-18T18:45:23+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3646","user":"anonymous","dateFinished":"2018-03-19T00:26:40+0000","dateStarted":"2018-03-19T00:26:22+0000"},{"title":"Pregunta 1C","text":"%pyspark\n# ¿Cuál es el delta de tiempo más grande entre una orden y otra?\n\nfrom pyspark.sql.functions import lag, col, lead\nfrom pyspark.sql.window import Window\nfrom pyspark.sql.functions import datediff, to_date, lit\n\np1c = orders\\\n    .orderBy(\"orderid\", ascending=True)\n    \nw = Window()\\\n    .partitionBy().\\\n    orderBy(col(\"orderid\"))\n    \np1c = p1c\\\n    .select(\"orderid\", \"orderdate\", lag(\"orderdate\" )\\\n        .over(w)\\\n        .alias(\"previous_order\"))\n\n\np1c = p1c.withColumn(\"delta\", \n              datediff(to_date(\"orderdate\", \"yyyy/MM/dd\"),\n                       to_date(\"previous_order\",\"yyyy/MM/dd\"))).orderBy(\"delta\", ascending = False).select(\"orderid\", \"delta\").limit(5)\n                       \n\np1c.write.csv('s3a://larrazolo/output/tarea6/p1c.csv')\n\np1c.show()\n","dateUpdated":"2018-03-19T00:26:38+0000","config":{"tableHide":false,"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-------+-----+\n|orderid|delta|\n+-------+-----+\n|  10262|    3|\n|  10284|    3|\n|  10267|    3|\n|  10256|    3|\n|  10273|    3|\n+-------+-----+\n\n"}]},"apps":[],"jobName":"paragraph_1521398723762_710712508","id":"20180316-194035_307186574","dateCreated":"2018-03-18T18:45:23+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3647","user":"anonymous","dateFinished":"2018-03-19T00:26:44+0000","dateStarted":"2018-03-19T00:26:38+0000"},{"title":"Ejercicio 2","text":"\n","user":"anonymous","dateUpdated":"2018-03-18T23:37:47+0000","config":{"editorSetting":{"language":"scala","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/scala","editorHide":false,"title":true,"results":{},"enabled":true,"tableHide":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1521398723763_710327759","id":"20180317-033627_1603100446","dateCreated":"2018-03-18T18:45:23+0000","dateStarted":"2018-03-18T23:33:32+0000","dateFinished":"2018-03-18T23:33:47+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3648"},{"title":"Pregunta 2A","text":"%pyspark\n#¿Qué aerolíneas (nombres) llegan al aeropuerto \"Honolulu International Airport\"?\n\n\nhonolulu = airports\\\n            .filter(airports[\"Airport\"] == \"Honolulu International Airport\")\\\n            .select(\"iata_code\", \"airport\")\n\np2a = flights\\\n        .join(honolulu, flights.DESTINATION_AIRPORT == honolulu.iata_code)\\\n        .select(\"airline\", \"airport\")\\\n        .distinct()\n\np2a = p2a\\\n        .join(airlines, p2a.airline == airlines.IATA_CODE)\\\n        .select(airlines.AIRLINE)\n\np2a.write.csv('s3a://larrazolo/output/tarea6/p2a.csv')\n\np2a.show()\n","dateUpdated":"2018-03-19T01:11:37+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+\n|             AIRLINE|\n+--------------------+\n|      Virgin America|\n|     US Airways Inc.|\n|Alaska Airlines Inc.|\n|Hawaiian Airlines...|\n|Delta Air Lines Inc.|\n|American Airlines...|\n|United Air Lines ...|\n+--------------------+\n\n"}]},"apps":[],"jobName":"paragraph_1521398723763_710327759","id":"20180316-204559_1094826660","dateCreated":"2018-03-18T18:45:23+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3649","user":"anonymous","dateFinished":"2018-03-19T01:13:38+0000","dateStarted":"2018-03-19T01:11:37+0000"},{"title":"Pregunta 2B","text":"%pyspark\n# ¿En qué horario (hora del día, no importan los minutos) hay salidas del aeropuerto de San Francisco (\"SFO\") a \"Honolulu International Airport\"\n\nfrom pyspark.sql.functions import *\n\np2b = flights[(flights.ORIGIN_AIRPORT.isin(['SFO'])) & (flights.DESTINATION_AIRPORT.isin(['HNL']))]\\\n    .select(\"ORIGIN_AIRPORT\", \"DESTINATION_AIRPORT\", \"DEPARTURE_TIME\")\\\n    .withColumn('Hour', when(flights.DEPARTURE_TIME > 1000, floor((flights.DEPARTURE_TIME)/100))\\\n        .otherwise(when(flights.DEPARTURE_TIME > 100, floor((flights.DEPARTURE_TIME)/100))\\\n        .otherwise(0)))\\\n    .select(\"Hour\")\\\n    .distinct()\\\n    .orderBy(\"Hour\", ascending=True)\n    \np2b.write.csv('s3a://larrazolo/output/tarea6/p2b.csv')\n\np2b.show()\n","dateUpdated":"2018-03-19T00:27:01+0000","config":{"editorSetting":{"language":"python","editOnDblClick":false},"colWidth":12,"editorMode":"ace/mode/python","title":true,"results":{},"enabled":true,"tableHide":false},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+----+\n|Hour|\n+----+\n|   0|\n|   1|\n|   6|\n|   7|\n|   8|\n|   9|\n|  10|\n|  11|\n|  12|\n|  13|\n|  14|\n|  15|\n|  16|\n|  17|\n|  18|\n|  19|\n|  20|\n|  21|\n|  22|\n|  23|\n+----+\n\n"}]},"apps":[],"jobName":"paragraph_1521398723763_710327759","id":"20180317-052818_1881162983","dateCreated":"2018-03-18T18:45:23+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3650","user":"anonymous","dateFinished":"2018-03-19T00:28:45+0000","dateStarted":"2018-03-19T00:27:01+0000"},{"title":"Pregunta 2C","text":"%pyspark\n\n#¿Qué día de la semana y en qué aerolínea nos conviene viajar a \"Honolulu International Airport\" para tener el menor retraso posible? \n\nimport pyspark.sql.functions as func\n\nhonolulu = airports.filter(airports[\"Airport\"] == \"Honolulu International Airport\").selectExpr(\"IATA_CODE as iata_code\", \"AIRPORT as airport_name\")\n\np2c = flights\\\n    .select(\"day_of_week\", \"airline\", \"destination_airport\", \"arrival_delay\")\\\n    .join(honolulu, flights.DESTINATION_AIRPORT == honolulu.iata_code)\\\n    .groupBy(\"day_of_week\", \"airline\").avg(\"arrival_delay\")\\\n    .orderBy(\"avg(arrival_delay)\")\\\n        .join(airlines, flights.AIRLINE == airlines.IATA_CODE)\\\n    .select(\"day_of_week\", airlines.AIRLINE, \"avg(arrival_delay)\")\\\n    .limit(1)\n    \np2c.write.csv('s3a://larrazolo/output/tarea6/p2c.csv')\n\np2c.show()\n","user":"anonymous","dateUpdated":"2018-03-19T00:28:21+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python","title":true},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-----------+--------------+-------------------+\n|day_of_week|       AIRLINE| avg(arrival_delay)|\n+-----------+--------------+-------------------+\n|          1|Virgin America|-14.222222222222221|\n+-----------+--------------+-------------------+\n\n"}]},"apps":[],"jobName":"paragraph_1521398744592_-1965570193","id":"20180318-184544_1718513407","dateCreated":"2018-03-18T18:45:44+0000","dateStarted":"2018-03-19T00:28:21+0000","dateFinished":"2018-03-19T00:29:04+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:3651"},{"text":"%pyspark\n\n#¿Cuál es el aeropuerto con mayor tráfico de entrada?\n\np2d = flights\\\n    .select(\"destination_airport\")\\\n    .groupBy(\"destination_airport\")\\\n    .count()\\\n    .orderBy(\"count\", ascending = False)\\\n    .limit(1).\\\n    join(airports, flights.DESTINATION_AIRPORT == airports.IATA_CODE)\\\n    .select(\"DESTINATION_AIRPORT\",\"AIRPORT\", \"count\")\n\np2d.write.csv('s3a://larrazolo/output/tarea6/p2d.csv')\n\np2d.show()\n\n","user":"anonymous","dateUpdated":"2018-03-19T00:28:45+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala","title":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1521401680033_-245546684","id":"20180318-193440_1977983480","dateCreated":"2018-03-18T19:34:40+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:5416","dateFinished":"2018-03-19T00:29:22+0000","dateStarted":"2018-03-19T00:28:45+0000","title":"Pregunta 2D","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-------------------+--------------------+------+\n|DESTINATION_AIRPORT|             AIRPORT| count|\n+-------------------+--------------------+------+\n|                ATL|Hartsfield-Jackso...|346904|\n+-------------------+--------------------+------+\n\n"}]}},{"text":"%pyspark\nfrom pyspark.sql.window import Window\n\n#¿Cuál es la aerolínea con mayor retraso de salida por día de la semana?\n\n\nw = Window\\\n    .partitionBy(\"day_of_week\")\\\n    .orderBy(desc(\"avg(departure_delay)\"))\n\np2e = flights\\\n    .select(\"day_of_week\", \"airline\" ,\"departure_delay\")\\\n    .groupBy(\"day_of_week\", \"airline\")\\\n    .avg(\"departure_delay\")\\\n    .withColumn(\"rank\", rank().over(w))\\\n    .filter(col(\"rank\") == 1)\\\n    .join(airlines, flights\\\n        .AIRLINE == airlines\\\n        .IATA_CODE)\\\n    .select(\"day_of_week\", airlines.AIRLINE)\\\n    .orderBy(\"day_of_week\")\n    \np2e.write.csv('s3a://larrazolo/output/tarea6/p2e.csv')\n    \np2e.show()\n\n","user":"anonymous","dateUpdated":"2018-03-19T00:29:05+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala","title":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1521402199611_-515902044","id":"20180318-194319_1239016063","dateCreated":"2018-03-18T19:43:19+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:5796","dateFinished":"2018-03-19T00:29:45+0000","dateStarted":"2018-03-19T00:29:05+0000","title":"Pregunta 2E","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+-----------+--------------------+\n|day_of_week|             AIRLINE|\n+-----------+--------------------+\n|          1|    Spirit Air Lines|\n|          2|    Spirit Air Lines|\n|          3|United Air Lines ...|\n|          4|United Air Lines ...|\n|          5|    Spirit Air Lines|\n|          6|    Spirit Air Lines|\n|          7|    Spirit Air Lines|\n+-----------+--------------------+\n\n"}]}},{"text":"%pyspark\nfrom pyspark.sql.window import Window\n\n# ¿Cuál es la tercer aerolínea con menor retraso de salida los lunes (day of week = 2)?\n\nw = Window.orderBy(\"avg(departure_delay)\")\n \n \np2f = flights\\\n    .select( \"day_of_week\" , \"airline\", \"departure_delay\")\\\n    .filter(col(\"day_of_week\") == 2)\\\n    .groupBy(\"airline\")\\\n    .avg(\"departure_delay\")\\\n    .orderBy(\"avg(departure_delay)\", ascending = True)\\\n    .withColumn(\"rank\", rank().over(w))\\\n    .filter(col(\"rank\")==3)\\\n    .join(airlines, flights.AIRLINE == airlines.IATA_CODE)\\\n    .select(\"rank\",\"IATA_CODE\", airlines.AIRLINE)\n    \np2f.write.csv('s3a://larrazolo/output/tarea6/p2f.csv')\n    \np2f.show()\n","user":"anonymous","dateUpdated":"2018-03-19T00:29:23+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala","title":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1521405141145_-274871921","id":"20180318-203221_733310395","dateCreated":"2018-03-18T20:32:21+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:6720","dateFinished":"2018-03-19T00:30:01+0000","dateStarted":"2018-03-19T00:29:23+0000","title":"Pregunta 2F","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+----+---------+---------------+\n|rank|IATA_CODE|        AIRLINE|\n+----+---------+---------------+\n|   3|       US|US Airways Inc.|\n+----+---------+---------------+\n\n"}]}},{"text":"%pyspark\n\n#¿Cuál es el aeropuerto origen que llega a la mayor cantidad de aeropuertos destino diferentes?\n\n\np2g = flights\\\n    .select(\"origin_airport\", \"destination_airport\")\\\n    .distinct()\\\n    .groupBy(\"origin_airport\")\\\n    .count()\\\n    .orderBy(\"count\", ascending = False)\\\n    .limit(1)\\\n    .join(airports, flights.ORIGIN_AIRPORT == airports.IATA_CODE)\\\n    .select(\"origin_airport\", \"AIRPORT\", \"count\")\n    \np2g.write.csv('s3a://larrazolo/output/tarea6/p2g.csv')\n    \np2g.show()\n\n    ","user":"anonymous","dateUpdated":"2018-03-19T00:33:41+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala","title":true},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1521406467064_1887104360","id":"20180318-205427_1608999108","dateCreated":"2018-03-18T20:54:27+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:7498","dateFinished":"2018-03-19T00:30:25+0000","dateStarted":"2018-03-19T00:29:45+0000","title":"Pregunta 2G","results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------+--------------------+-----+\n|origin_airport|             AIRPORT|count|\n+--------------+--------------------+-----+\n|           ATL|Hartsfield-Jackso...|  169|\n+--------------+--------------------+-----+\n\n"}]}},{"dateUpdated":"2018-03-18T18:45:23+0000","config":{"colWidth":12,"editorMode":"ace/mode/scala","results":{},"enabled":true,"editorSetting":{"language":"scala","editOnDblClick":false}},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1521398723766_709173512","id":"20180317-033213_1575668445","dateCreated":"2018-03-18T18:45:23+0000","status":"READY","errorMessage":"","progressUpdateIntervalMs":500,"$$hashKey":"object:3656"}],"name":"Tarea 6","id":"2DA1BRPTK","angularObjects":{"2BRWU4WXC:shared_process":[],"2AM1YV5CU:shared_process":[],"2AJXGMUUJ:shared_process":[],"2ANGGHHMQ:shared_process":[],"2AKK3QQXU:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}