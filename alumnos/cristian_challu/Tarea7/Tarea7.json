{"paragraphs":[{"text":"%pyspark\n\nfrom pyspark.ml import Pipeline\nfrom pyspark.ml.evaluation import BinaryClassificationEvaluator\nfrom pyspark.ml.feature import HashingTF, Tokenizer\nfrom pyspark.ml.tuning import CrossValidator, ParamGridBuilder\nfrom pyspark.ml.linalg import Vectors\nfrom pyspark.ml.feature import VectorAssembler\nfrom pyspark.ml.feature import OneHotEncoder, StringIndexer\nfrom pyspark.ml.regression import LinearRegression, RandomForestRegressor\nfrom pyspark.sql.types import DoubleType\nfrom pyspark.sql import SparkSession\nfrom pyspark.sql.functions import *\nfrom pyspark.ml.base import Estimator, Model, Transformer\nfrom pyspark.ml.evaluation import RegressionEvaluator\nimport numpy as np\nimport time","user":"anonymous","dateUpdated":"2018-04-24T00:23:34+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1524519656013_-691575983","id":"20180423-214056_2078081431","dateCreated":"2018-04-23T21:40:56+0000","dateStarted":"2018-04-24T00:23:34+0000","dateFinished":"2018-04-24T00:23:34+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:259"},{"text":"%pyspark\n\nflights_orig = spark.read.csv(\"s3://cristian-challu/tarea5/bases/flights/vuelos/flights.csv\", header =True)","user":"anonymous","dateUpdated":"2018-04-24T00:23:36+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1524519658867_-2011634135","id":"20180423-214058_1525979201","dateCreated":"2018-04-23T21:40:58+0000","dateStarted":"2018-04-24T00:23:36+0000","dateFinished":"2018-04-24T00:23:37+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:260"},{"text":"%pyspark\n\nclass SelectCols(Transformer):  \n\n    def __init__(self, columns=[None]):\n        self.columns = columns\n\n    def _transform(self, df):\n        df = df.select(self.columns)\n        self = df\n        return self\n    \nclass RenameCol(Transformer):  \n\n    def __init__(self, old=None, new=None):\n        self.old = old\n        self.new = new\n\n    def _transform(self, df):\n        df = df.withColumnRenamed(self.old,self.new)\n        self = df\n        return self\n\nclass StringToInt(Transformer):  \n\n    def __init__(self, columns=[None]):\n        self.columns = columns\n\n    def _transform(self, df):\n        for col in self.columns:\n            df = df.withColumn(col, df[col].cast(DoubleType()))\n        self = df\n        return self\n    \nclass DropNulls(Transformer):  \n    def _transform(self, df):\n        self = df.na.drop(subset=df.columns)\n        return self","user":"anonymous","dateUpdated":"2018-04-24T00:23:41+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1524521752131_-1291211816","id":"20180423-221552_1709176990","dateCreated":"2018-04-23T22:15:52+0000","dateStarted":"2018-04-24T00:23:41+0000","dateFinished":"2018-04-24T00:23:41+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:261"},{"text":"%pyspark\n\nselect_cols_1 = SelectCols([\"MONTH\",\"DAY\",\"DAY_OF_WEEK\",\"AIRLINE\",\"DEPARTURE_DELAY\", \"ORIGIN_AIRPORT\", \"DISTANCE\"])\ndrop_nulls = DropNulls()\nindexers = [StringIndexer(inputCol=column, outputCol=column+\"_index\") for column in [\"MONTH\",\"DAY\",\"DAY_OF_WEEK\",\"AIRLINE\", \"ORIGIN_AIRPORT\"]]\nencoders = [OneHotEncoder(inputCol=column, outputCol=column+\"_vec\") for column in [\"MONTH_index\",\"DAY_index\",\"DAY_OF_WEEK_index\",\"AIRLINE_index\", \"ORIGIN_AIRPORT_index\"]]\nrename_label = RenameCol(\"DEPARTURE_DELAY\",\"label\")\ncast_label = StringToInt([\"label\", \"DISTANCE\"])\nassembler = VectorAssembler(\n    inputCols=[\"MONTH_index_vec\", \"DAY_index_vec\", \"DAY_OF_WEEK_index_vec\", \"AIRLINE_index_vec\", \"ORIGIN_AIRPORT_index_vec\", \"DISTANCE\"],\n    outputCol=\"features\")\nselect_cols_2 = SelectCols([\"features\",\"label\"])\n\npipeline = Pipeline(stages=[select_cols_1, drop_nulls] + indexers + encoders + [rename_label, cast_label, assembler, select_cols_2])\nflights = pipeline.fit(flights_orig).transform(flights_orig)\n\nflights.show()","user":"anonymous","dateUpdated":"2018-04-24T00:23:45+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"+--------------------+-----+\n|            features|label|\n+--------------------+-----+\n|(688,[10,36,41,56...|-11.0|\n|(688,[10,36,41,49...| -8.0|\n|(688,[10,36,41,55...| -2.0|\n|(688,[10,36,41,49...| -5.0|\n|(688,[10,36,41,56...| -1.0|\n|(688,[10,36,41,48...| -5.0|\n|(688,[10,36,41,57...| -6.0|\n|(688,[10,36,41,55...| 14.0|\n|(688,[10,36,41,49...|-11.0|\n|(688,[10,36,41,48...|  3.0|\n|(688,[10,36,41,48...| -6.0|\n|(688,[10,36,41,49...| -8.0|\n|(688,[10,36,41,48...|  0.0|\n|(688,[10,36,41,48...| -6.0|\n|(688,[10,36,41,48...| -1.0|\n|(688,[10,36,41,56...| -4.0|\n|(688,[10,36,41,48...|-14.0|\n|(688,[10,36,41,52...| -6.0|\n|(688,[10,36,41,56...| -4.0|\n|(688,[10,36,41,48...| -5.0|\n+--------------------+-----+\nonly showing top 20 rows\n\n"}]},"apps":[],"jobName":"paragraph_1524521821410_-1900395207","id":"20180423-221701_2074570867","dateCreated":"2018-04-23T22:17:01+0000","dateStarted":"2018-04-24T00:23:45+0000","dateFinished":"2018-04-24T00:24:07+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:262"},{"text":"%pyspark\n\n(train_data, test_data) = flights.randomSplit([0.7, 0.3])\n","user":"anonymous","dateUpdated":"2018-04-24T00:24:13+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1524521843074_-2125641879","id":"20180423-221723_338562083","dateCreated":"2018-04-23T22:17:23+0000","dateStarted":"2018-04-24T00:24:13+0000","dateFinished":"2018-04-24T00:24:13+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:263"},{"text":"%pyspark\n\ndef magic_loop(models_to_run, clfs, grids, X):\n    models = {}\n    for n in range(1, 2):\n        # For para iterar a lo largo de los pipes que haya recibido\n        for clf in models_to_run:\n            print(clf)\n            # Grid search para encontrar los parámetros óptimos para cada modelo\n            pipe = Pipeline(stages=[clfs[clf]])\n            crossval = CrossValidator(estimator=pipe,\n                          estimatorParamMaps=grids[clf],\n                          evaluator=RegressionEvaluator(metricName='rmse'),\n                          numFolds=10)\n            models[clf] = crossval.fit(X)\n    return models\n","user":"anonymous","dateUpdated":"2018-04-24T22:13:10+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1524521948059_2052715851","id":"20180423-221908_435075868","dateCreated":"2018-04-23T22:19:08+0000","dateStarted":"2018-04-24T22:13:10+0000","dateFinished":"2018-04-24T22:13:10+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:264"},{"text":"%pyspark\n\n# Definimos los modelos a utilizar\nmodels_to_run = ['RF','LR']\n\n# Creamos un diccionario de los modelos\nclassifiers = {'LR':LinearRegression(maxIter = 10),\n              'RF': RandomForestRegressor(featureSubsetStrategy='onethird')}\n\nparamGrid_lr = ParamGridBuilder() \\\n    .addGrid(classifiers['LR'].maxIter, [5, 7, 10]) \\\n    .addGrid(classifiers['LR'].regParam, [0.1, 0.05, 0.01]) \\\n    .build()\n    \nparamGrid_rf = ParamGridBuilder() \\\n    .addGrid(classifiers['RF'].numTrees, [1, 5, 10]) \\\n    .addGrid(classifiers['RF'].subsamplingRate,[0.1, 0.15, 0.20])\\\n    .build()\n    \ngrids = {'LR':paramGrid_lr,\n        'RF': paramGrid_rf}","user":"anonymous","dateUpdated":"2018-04-24T00:24:40+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1524521963100_1872884873","id":"20180423-221923_573145866","dateCreated":"2018-04-23T22:19:23+0000","dateStarted":"2018-04-24T00:24:40+0000","dateFinished":"2018-04-24T00:24:40+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:265"},{"text":"%pyspark\n\nstart = time.time()\nm_loop = magic_loop(models_to_run, classifiers, grids, train_data)\nend = time.time()","user":"anonymous","dateUpdated":"2018-04-24T02:59:16+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"RF\nLR\n"}]},"apps":[],"jobName":"paragraph_1524521981255_944885851","id":"20180423-221941_554901237","dateCreated":"2018-04-23T22:19:41+0000","dateStarted":"2018-04-24T00:25:09+0000","dateFinished":"2018-04-24T01:29:18+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:266"},{"text":"%pyspark\nprint(\"Tiempo de ejecucucion:\", end-start)","user":"anonymous","dateUpdated":"2018-04-24T01:59:29+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"('Tiempo de ejecucucion:', 3849.007668018341)\n"}]},"apps":[],"jobName":"paragraph_1524521990906_-1278578043","id":"20180423-221950_306859912","dateCreated":"2018-04-23T22:19:50+0000","dateStarted":"2018-04-24T01:59:29+0000","dateFinished":"2018-04-24T01:59:29+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:267"},{"text":"%pyspark\n\nparameters_rf = m_loop['RF'].getEstimatorParamMaps()\nparameters_rf[np.argmin(m_loop['RF'].avgMetrics)]","user":"anonymous","dateUpdated":"2018-04-24T01:59:36+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"{Param(parent=u'RandomForestRegressor_4ab09b5fb2a37e926437', name='numTrees', doc='Number of trees to train (>= 1).'): 10, Param(parent=u'RandomForestRegressor_4ab09b5fb2a37e926437', name='subsamplingRate', doc='Fraction of the training data used for learning each decision tree, in range (0, 1].'): 0.2}\n"}]},"apps":[],"jobName":"paragraph_1524522362936_579878449","id":"20180423-222602_1864642187","dateCreated":"2018-04-23T22:26:02+0000","dateStarted":"2018-04-24T01:59:36+0000","dateFinished":"2018-04-24T01:59:36+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:268"},{"text":"%pyspark\n\nparameters_lr = m_loop['LR'].getEstimatorParamMaps()\nparameters_lr[np.argmin(m_loop['LR'].avgMetrics)]","user":"anonymous","dateUpdated":"2018-04-24T01:59:41+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"{Param(parent=u'LinearRegression_4e35a46127015bfde1a6', name='maxIter', doc='max number of iterations (>= 0).'): 5, Param(parent=u'LinearRegression_4e35a46127015bfde1a6', name='regParam', doc='regularization parameter (>= 0).'): 0.1}\n"}]},"apps":[],"jobName":"paragraph_1524522377453_2094665517","id":"20180423-222617_1997788350","dateCreated":"2018-04-23T22:26:17+0000","dateStarted":"2018-04-24T01:59:41+0000","dateFinished":"2018-04-24T01:59:41+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:269"},{"text":"%pyspark\nprint(\"RF:\", np.min(m_loop['RF'].avgMetrics), \"LR:\", np.min(m_loop['LR'].avgMetrics))\n","user":"anonymous","dateUpdated":"2018-04-24T01:59:43+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"('RF:', 36.916799349138216, 'LR:', 36.80668610731569)\n"}]},"apps":[],"jobName":"paragraph_1524522394766_-269985899","id":"20180423-222634_1326485325","dateCreated":"2018-04-23T22:26:34+0000","dateStarted":"2018-04-24T01:59:43+0000","dateFinished":"2018-04-24T01:59:43+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:270"},{"text":"%pyspark\n\nevaluator = RegressionEvaluator(metricName='rmse')\n\nprint(\"RF:\", evaluator.evaluate(m_loop['RF'].transform(test_data)), \"LR:\", evaluator.evaluate(m_loop['LR'].transform(test_data)))","user":"anonymous","dateUpdated":"2018-04-24T01:59:45+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"('RF:', 36.84069292483854, 'LR:', 36.73486590178921)\n"}]},"apps":[],"jobName":"paragraph_1524522422103_-1620992529","id":"20180423-222702_1537731625","dateCreated":"2018-04-23T22:27:02+0000","dateStarted":"2018-04-24T01:59:45+0000","dateFinished":"2018-04-24T02:00:01+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:271"},{"text":"%pyspark\n","user":"anonymous","dateUpdated":"2018-04-23T22:53:52+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1524524032291_42959976","id":"20180423-225352_1412903911","dateCreated":"2018-04-23T22:53:52+0000","status":"READY","progressUpdateIntervalMs":500,"$$hashKey":"object:272"}],"name":"Tarea7","id":"2DBXJECGC","angularObjects":{"2BRWU4WXC:shared_process":[],"2AM1YV5CU:shared_process":[],"2AJXGMUUJ:shared_process":[],"2ANGGHHMQ:shared_process":[],"2AKK3QQXU:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}