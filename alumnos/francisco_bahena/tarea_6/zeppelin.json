{"paragraphs":[{"text":"%spark.pyspark\nspark\nvuelos = spark.read.csv(\"s3://tristanvhbucket/data/flights.csv\",header=True)\nairlines = spark.read.csv(\"s3://tristanvhbucket/data/airlines.csv\",header=True)\nairports = spark.read.csv(\"s3://tristanvhbucket/data/airports.csv\",header=True)\norder_details = spark.read.csv(\"s3://tristanvhbucket/data/order_details.csv\",header=True)\norders = spark.read.csv(\"s3://tristanvhbucket/data/orders.csv\",header=True)\nemployees = spark.read.csv(\"s3://tristanvhbucket/data/employees.csv\",header=True)\nproducts = spark.read.csv(\"s3://tristanvhbucket/data/products.csv\",header=True)","user":"anonymous","dateUpdated":"2018-03-20T03:21:19+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1521500795020_-2706718","id":"20180319-230635_1840527289","dateCreated":"2018-03-19T23:06:35+0000","dateStarted":"2018-03-20T03:21:19+0000","dateFinished":"2018-03-20T03:21:32+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:378"},{"text":"%pyspark\n\n\n_\n### ¿Cuántos “jefes” hay en la tabla empleados ?\nemployees.filter(employees.reportsto > 0).select('reportsto').distinct().count()","user":"anonymous","dateUpdated":"2018-03-20T01:53:51+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"2\n"}]},"apps":[],"jobName":"paragraph_1521509262865_1333887111","id":"20180320-012742_651484251","dateCreated":"2018-03-20T01:27:42+0000","dateStarted":"2018-03-20T01:53:51+0000","dateFinished":"2018-03-20T01:54:03+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:379"},{"text":"%pyspark\nfrom pyspark.sql.functions import *\n\n\n#¿Cuántos “jefes” hay en la tabla empleados ?\n\n\nempleados = employees.filter(employees.reportsto > 0).selectExpr(\"firstname as name\", \"reportsto as reporta_a\").groupby('reporta_a').agg((collect_set(\"name\")).alias('empleados'))\n\n\ndf3 = empleados.join(employees, empleados.reporta_a==employees.employeeid)\n\nej1a = df3.withColumn(\"empleado\", explode(df3.empleados)).\\\nselect('firstname','lastname','employeeid','title','birthdate','hiredate','city','country','reporta_a','empleado')\n\nej1a.coalesce(1).write.csv('s3://tristanvhbucket/tarea_spark/ej1a.csv', header=True)\n","user":"anonymous","dateUpdated":"2018-03-20T06:29:40+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1521500813843_-1458581232","id":"20180319-230653_1702847780","dateCreated":"2018-03-19T23:06:53+0000","dateStarted":"2018-03-20T06:29:40+0000","dateFinished":"2018-03-20T06:29:57+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:380"},{"text":"%pyspark\n\n#¿Quién es el segundo “mejor” empleado que más órdenes ha generado?\nordenes = orders.groupby('employeeid').count().selectExpr('employeeid as idempleado','count as ordenes')\ntabla = employees.join(ordenes, employees.employeeid==ordenes.idempleado).select('firstname','lastname','hiredate','title','ordenes').\\\norderBy(desc('ordenes'))\n\nej1b = tabla.withColumn('maximo',lit(tabla.groupby().max('ordenes').collect()[0][0])).limit(2).orderBy('ordenes').limit(1)\n\nej1b.coalesce(1).write.csv('s3://tristanvhbucket/tarea_spark/ej1b.csv', header=True)","user":"anonymous","dateUpdated":"2018-03-20T06:30:23+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1521500821206_1855443290","id":"20180319-230701_1613858404","dateCreated":"2018-03-19T23:07:01+0000","dateStarted":"2018-03-20T06:30:23+0000","dateFinished":"2018-03-20T06:30:28+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:381"},{"text":"%pyspark\nfrom pyspark.sql import Window\n\n#¿Cuál es el delta de tiempo más grande entre una orden y otra?\n\ntabla_lag = orders.orderBy(\"orderId\").select(\"orderid\",\"orderdate\", lag(\"orderdate\").over(Window.orderBy(\"orderid\")).alias(\"laggeada\"))\ntabla_lag = tabla_lag.withColumn(\"diff\",datediff(to_date(\"orderdate\"),to_date(\"laggeada\"))).orderBy(\"diff\",ascending=False)\nej1c = tabla_lag.groupby().agg({'diff':'max'})\nej1c.coalesce(1).write.csv('s3://tristanvhbucket/tarea_spark/ej1c.csv', header=True)","user":"anonymous","dateUpdated":"2018-03-20T06:30:52+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"results":{"code":"SUCCESS","msg":[]},"apps":[],"jobName":"paragraph_1521501719011_1240329966","id":"20180319-232159_1214830136","dateCreated":"2018-03-19T23:21:59+0000","dateStarted":"2018-03-20T06:30:52+0000","dateFinished":"2018-03-20T06:30:55+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:382"},{"text":"%pyspark\n#Ejercicio 2\n\n#a) ¿Qué aerolíneas (nombres) llegan al aeropuerto \"Honolulu International Airport\"?\n\nvuelos_unicos = vuelos.selectExpr('AIRLINE','DESTINATION_AIRPORT').distinct()\nvuelos_target = vuelos_unicos.join(airports, vuelos_unicos.DESTINATION_AIRPORT==airports.IATA_CODE).\\\nfilter(airports.AIRPORT== 'Honolulu International Airport').select('AIRLINE','AIRPORT','IATA_CODE')\n\naerolineas = airlines.selectExpr('IATA_CODE as cod','AIRLINE as aerolinea')\nej2a = aerolineas.join(vuelos_target, aerolineas.cod == vuelos_target.AIRLINE)\nej2a.coalesce(1).write.csv('s3://tristanvhbucket/tarea_spark/ej2a.csv', header=True)\n","user":"anonymous","dateUpdated":"2018-03-20T06:31:12+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1521511211565_961070884","id":"20180320-020011_539115201","dateCreated":"2018-03-20T02:00:11+0000","status":"FINISHED","progressUpdateIntervalMs":500,"$$hashKey":"object:383","dateFinished":"2018-03-20T06:31:27+0000","dateStarted":"2018-03-20T06:31:12+0000","results":{"code":"SUCCESS","msg":[]}},{"text":"%pyspark\n\n# b) ¿En qué horario (hora del día, no importan los minutos) hay salidas del aeropuerto de San Francisco (“SFO”) a “Honolulu International Airport”?\n\nvuelos_hon = vuelos.select('SCHEDULED_DEPARTURE','DESTINATION_AIRPORT','ORIGIN_AIRPORT').filter((col(\"DESTINATION_AIRPORT\") == \"HNL\") & (col(\"ORIGIN_AIRPORT\") == \"SFO\"))\nej2b=vuelos_hon.withColumn('hora',vuelos_hon['SCHEDULED_DEPARTURE'].substr(0, 2)).groupby('hora').count().\\\nselectExpr('hora','count as vuelos').orderBy('vuelos',ascending=False)\n\nej2b.coalesce(1).write.csv('s3://tristanvhbucket/tarea_spark/ej2b.csv', header=True)","user":"anonymous","dateUpdated":"2018-03-20T06:32:45+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1521515943448_309632391","id":"20180320-031903_324625974","dateCreated":"2018-03-20T03:19:03+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:786","dateFinished":"2018-03-20T06:33:11+0000","dateStarted":"2018-03-20T06:32:45+0000","results":{"code":"SUCCESS","msg":[]}},{"text":"%pyspark\n\n# c) ¿Qué día de la semana y en qué aerolínea nos conviene viajar a “Honolulu International Airport” para tener el menor retraso posible?\n\nej2c = vuelos.filter((col('DEPARTURE_DELAY') > 0) & (col('DESTINATION_AIRPORT') == 'HNL')).\\\nselect('DAY_OF_WEEK','AIRLINE','DEPARTURE_DELAY','DESTINATION_AIRPORT').\\\ngroupby('DAY_OF_WEEK','AIRLINE').agg({'DEPARTURE_DELAY':'avg'}).orderBy('avg(DEPARTURE_DELAY)').limit(1)\nej2c.coalesce(1).write.csv('s3://tristanvhbucket/tarea_spark/ej2c.csv', header=True)","user":"anonymous","dateUpdated":"2018-03-20T06:33:21+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1521516285833_2071283234","id":"20180320-032445_1966473283","dateCreated":"2018-03-20T03:24:45+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1084","dateFinished":"2018-03-20T06:33:31+0000","dateStarted":"2018-03-20T06:33:21+0000","results":{"code":"SUCCESS","msg":[]}},{"text":"%pyspark\n# d) ¿Cuál es el aeropuerto con mayor tráfico de entrada?\n\npuerto = vuelos.selectExpr('ORIGIN_AIRPORT AS origin','DESTINATION_AIRPORT as destination').\\\ngroupby('destination').count().selectExpr('destination','count as vuelos_que_llegan').\\\norderBy('vuelos_que_llegan',ascending=False).limit(1)\n\nej2d = puerto.join(airports, puerto.destination==airports.IATA_CODE)\n\nej2d.coalesce(1).write.csv('s3://tristanvhbucket/tarea_spark/ej2d.csv', header=True)\n","user":"anonymous","dateUpdated":"2018-03-20T06:37:57+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1521521867852_-92204233","id":"20180320-045747_424147494","dateCreated":"2018-03-20T04:57:47+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1602","dateFinished":"2018-03-20T06:38:43+0000","dateStarted":"2018-03-20T06:37:57+0000","results":{"code":"SUCCESS","msg":[]}},{"text":"%pyspark\n\n#e) ¿Cuál es la aerolínea con mayor retraso de salida por día de la semana?\n\nretraso_max = vuelos.filter(col('DEPARTURE_DELAY') > 0).\\\nselect('DAY_OF_WEEK','AIRLINE','DEPARTURE_DELAY','DESTINATION_AIRPORT').\\\ngroupby('DAY_OF_WEEK','AIRLINE').agg({'DEPARTURE_DELAY':'avg'}).orderBy('avg(DEPARTURE_DELAY)').\\\nselect(\"DAY_OF_WEEK\", \"AIRLINE\",col(\"avg(DEPARTURE_DELAY)\").alias(\"retraso\")).\\\ngroupby('DAY_OF_WEEK').agg({'retraso':'max'}).\\\nselect('DAY_OF_WEEK',col('max(retraso)').alias(\"max_retraso_avg\"))\n\nairlines_delay = vuelos.filter(col('DEPARTURE_DELAY') > 0).\\\nselect('DAY_OF_WEEK','AIRLINE','DEPARTURE_DELAY','DESTINATION_AIRPORT').\\\ngroupby('DAY_OF_WEEK','AIRLINE').agg({'DEPARTURE_DELAY':'avg'}).orderBy('avg(DEPARTURE_DELAY)').\\\nselect(col(\"DAY_OF_WEEK\").alias('dsem'), \"AIRLINE\",col(\"avg(DEPARTURE_DELAY)\").alias(\"retraso_prom\"))\n\ntabla = retraso_max.join(airlines_delay, retraso_max.max_retraso_avg==airlines_delay.retraso_prom).\\\nselect('DAY_OF_WEEK',col('AIRLINE').alias('aerolinea'),'max_retraso_avg').orderBy('DAY_OF_WEEK')\n\nej2e = tabla.join(airlines, tabla.aerolinea==airlines.IATA_CODE)\n\nej2e.coalesce(1).write.csv('s3://tristanvhbucket/tarea_spark/ej2e.csv', header=True)\n\n\n","user":"anonymous","dateUpdated":"2018-03-20T06:37:46+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1521523086556_-802474773","id":"20180320-051806_837314723","dateCreated":"2018-03-20T05:18:06+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1980","dateFinished":"2018-03-20T06:38:34+0000","dateStarted":"2018-03-20T06:37:46+0000","results":{"code":"SUCCESS","msg":[]}},{"text":"%pyspark\n\n# f)\n\nretrasos = vuelos.filter(vuelos.DAY_OF_WEEK==2).filter(vuelos.DEPARTURE_DELAY>0).\\\nselect(col('AIRLINE').alias('aerolinea'),'DEPARTURE_DELAY').\\\ngroupby('aerolinea').agg({'DEPARTURE_DELAY':'avg'}).\\\nselect('aerolinea',col('avg(DEPARTURE_DELAY)').alias('avg_delay_mondays')).orderBy('avg_delay_mondays',ascending=True).\\\nlimit(3)\n\nej2f = retrasos.join(airlines, retrasos.aerolinea==airlines.IATA_CODE).orderBy('avg_delay_mondays',ascending=False).limit(1)\n\nej2f.coalesce(1).write.csv('s3://tristanvhbucket/tarea_spark/ej2f.csv', header=True)\n","user":"anonymous","dateUpdated":"2018-03-20T06:38:47+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1521523446473_366096293","id":"20180320-052406_261714121","dateCreated":"2018-03-20T05:24:06+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:2161","dateFinished":"2018-03-20T06:38:55+0000","dateStarted":"2018-03-20T06:38:47+0000","results":{"code":"SUCCESS","msg":[]}},{"text":"    %pyspark\n    \n    #g)\n    \n    salidas = vuelos.select('ORIGIN_AIRPORT','DESTINATION_AIRPORT').\\\n    groupBy(\"ORIGIN_AIRPORT\").agg(countDistinct(\"DESTINATION_AIRPORT\").alias('destinos_diferentes')).\\\n    orderBy('destinos_diferentes',ascending=False)\n    \n    ej2g = salidas.join(airports, salidas.ORIGIN_AIRPORT==airports.IATA_CODE).limit(1)\n    \n    ej2g.coalesce(1).write.csv('s3://tristanvhbucket/tarea_spark/ej2g.csv', header=True)\n","user":"anonymous","dateUpdated":"2018-03-20T06:53:23+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"python","editOnDblClick":false},"editorMode":"ace/mode/python"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1521525753969_-2011691672","id":"20180320-060233_2140473470","dateCreated":"2018-03-20T06:02:33+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:3122","dateFinished":"2018-03-20T06:39:27+0000","dateStarted":"2018-03-20T06:39:15+0000","results":{"code":"SUCCESS","msg":[]}},{"text":"%pyspark\n","user":"anonymous","dateUpdated":"2018-03-20T06:05:55+0000","config":{"colWidth":12,"enabled":true,"results":{},"editorSetting":{"language":"scala","editOnDblClick":false},"editorMode":"ace/mode/scala"},"settings":{"params":{},"forms":{}},"apps":[],"jobName":"paragraph_1521525955242_2063308166","id":"20180320-060555_1577778301","dateCreated":"2018-03-20T06:05:55+0000","status":"READY","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:3301"}],"name":"nuevo","id":"2DBQ6DBWS","angularObjects":{"2BRWU4WXC:shared_process":[],"2AM1YV5CU:shared_process":[],"2AJXGMUUJ:shared_process":[],"2ANGGHHMQ:shared_process":[],"2AKK3QQXU:shared_process":[]},"config":{"looknfeel":"default","personalizedMode":"false"},"info":{}}